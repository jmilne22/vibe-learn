<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Course Builder | vibe-learn</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ===== Reset & Variables ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-dark: #0a0a0f;
  --bg-card: #12121a;
  --bg-code: #1a1a24;
  --bg-lighter: #1f1f2a;
  --green-bright: #00ff9d;
  --green-dim: #00cc7d;
  --green-glow: rgba(0, 255, 157, 0.15);
  --orange: #ff9d00;
  --purple: #9d00ff;
  --blue: #00b4ff;
  --cyan: #00d4ff;
  --red: #ff4757;
  --text-main: #e0e0e0;
  --text-dim: #888;
  --border: #2a2a3a;
  --font-body: 'Space Grotesk', system-ui, sans-serif;
  --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
  --radius: 8px;
  --transition: 0.2s ease;
}

body {
  font-family: var(--font-body);
  background: var(--bg-dark);
  color: var(--text-main);
  line-height: 1.6;
  min-height: 100vh;
}

/* ===== Layout ===== */
.app-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 24px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-card);
  position: sticky;
  top: 0;
  z-index: 100;
}

.app-header h1 {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--green-bright);
  letter-spacing: -0.02em;
}

.app-header .status {
  font-size: 0.8rem;
  color: var(--text-dim);
  font-family: var(--font-mono);
}

.app-header .status.dirty { color: var(--orange); }
.app-header .status.saving { color: var(--cyan); }
.app-header .status.error { color: var(--red); }

.header-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 24px;
}

/* ===== Tabs ===== */
.tab-bar {
  display: flex;
  gap: 2px;
  padding: 12px 24px 0;
  overflow-x: auto;
  background: var(--bg-dark);
  border-bottom: 1px solid var(--border);
}

.tab-btn {
  padding: 8px 16px;
  background: none;
  border: 1px solid transparent;
  border-bottom: none;
  color: var(--text-dim);
  font-family: var(--font-body);
  font-size: 0.85rem;
  cursor: pointer;
  border-radius: var(--radius) var(--radius) 0 0;
  transition: var(--transition);
  white-space: nowrap;
}

.tab-btn:hover { color: var(--text-main); background: var(--bg-card); }
.tab-btn.active {
  color: var(--green-bright);
  background: var(--bg-card);
  border-color: var(--border);
}

.tab-content {
  display: none;
  padding: 24px;
}
.tab-content.active { display: block; }

/* ===== Buttons ===== */
button, .btn {
  font-family: var(--font-body);
  cursor: pointer;
  border: none;
  border-radius: var(--radius);
  transition: var(--transition);
  font-size: 0.85rem;
}

.btn-primary {
  background: var(--green-bright);
  color: #000;
  padding: 8px 16px;
  font-weight: 600;
}
.btn-primary:hover { background: var(--green-dim); }

.btn-secondary {
  background: var(--bg-lighter);
  color: var(--text-main);
  padding: 8px 16px;
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--border); }

.btn-danger {
  background: transparent;
  color: var(--red);
  padding: 6px 12px;
  border: 1px solid var(--red);
}
.btn-danger:hover { background: rgba(255, 71, 87, 0.1); }

.btn-small {
  padding: 4px 10px;
  font-size: 0.78rem;
}

.btn-icon {
  background: none;
  border: none;
  color: var(--text-dim);
  padding: 4px;
  font-size: 1rem;
  line-height: 1;
}
.btn-icon:hover { color: var(--text-main); }

/* ===== Forms ===== */
.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-size: 0.8rem;
  color: var(--text-dim);
  margin-bottom: 4px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

input[type="text"], input[type="number"], textarea, select {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-main);
  font-family: var(--font-body);
  font-size: 0.9rem;
  transition: var(--transition);
}

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--green-bright);
  box-shadow: 0 0 0 2px var(--green-glow);
}

textarea {
  font-family: var(--font-mono);
  font-size: 0.85rem;
  line-height: 1.5;
  resize: vertical;
  min-height: 80px;
  tab-size: 2;
}

textarea.code-editor {
  min-height: 200px;
}

select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 32px;
  cursor: pointer;
}

input[type="checkbox"] {
  appearance: none;
  width: 18px;
  height: 18px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--bg-code);
  cursor: pointer;
  position: relative;
  vertical-align: middle;
}
input[type="checkbox"]:checked {
  background: var(--green-bright);
  border-color: var(--green-bright);
}
input[type="checkbox"]:checked::after {
  content: '';
  position: absolute;
  left: 5px; top: 2px;
  width: 5px; height: 9px;
  border: solid #000;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.checkbox-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.checkbox-row label {
  text-transform: none;
  letter-spacing: normal;
  font-size: 0.9rem;
  color: var(--text-main);
  margin-bottom: 0;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.form-hint {
  font-size: 0.75rem;
  color: var(--text-dim);
  margin-top: 2px;
}

/* ===== Cards ===== */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.card-header h3 {
  font-size: 0.95rem;
  font-weight: 600;
}

.card-actions {
  display: flex;
  gap: 4px;
}

/* ===== Collapsible ===== */
.collapsible-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--bg-lighter);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  user-select: none;
  transition: var(--transition);
  width: 100%;
  text-align: left;
  color: var(--text-main);
  font-family: var(--font-body);
  font-size: 0.9rem;
}
.collapsible-header:hover { border-color: var(--green-dim); }

.collapsible-arrow {
  transition: transform 0.2s;
  font-size: 0.7rem;
  color: var(--text-dim);
}
.collapsible-header.open .collapsible-arrow { transform: rotate(90deg); }

.collapsible-body {
  display: none;
  padding: 12px;
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 var(--radius) var(--radius);
  background: var(--bg-card);
}
.collapsible-body.open { display: block; }

/* ===== Dynamic list ===== */
.dyn-list-item {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.dyn-list-item input {
  flex: 1;
}

/* ===== Split pane ===== */
.split-pane {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  min-height: 500px;
}

.split-pane .pane-header {
  font-size: 0.8rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 8px;
  font-weight: 500;
}

.split-pane textarea {
  height: 100%;
  min-height: 500px;
}

.preview-pane {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 20px;
  overflow-y: auto;
  max-height: 700px;
  line-height: 1.7;
}

.preview-pane h1, .preview-pane h2, .preview-pane h3 {
  color: var(--green-bright);
  margin: 1.2em 0 0.5em;
}
.preview-pane h1 { font-size: 1.5rem; }
.preview-pane h2 { font-size: 1.25rem; border-bottom: 1px solid var(--border); padding-bottom: 6px; }
.preview-pane h3 { font-size: 1.1rem; }
.preview-pane code {
  background: var(--bg-code);
  padding: 2px 6px;
  border-radius: 3px;
  font-family: var(--font-mono);
  font-size: 0.85em;
}
.preview-pane pre {
  background: var(--bg-code);
  padding: 12px;
  border-radius: var(--radius);
  overflow-x: auto;
  margin: 1em 0;
}
.preview-pane pre code { background: none; padding: 0; }
.preview-pane blockquote {
  border-left: 3px solid var(--green-bright);
  padding: 8px 16px;
  margin: 1em 0;
  background: var(--bg-lighter);
  border-radius: 0 var(--radius) var(--radius) 0;
}
.preview-pane ul, .preview-pane ol { margin: 0.5em 0; padding-left: 1.5em; }
.preview-pane li { margin: 0.3em 0; }
.preview-pane table { border-collapse: collapse; width: 100%; margin: 1em 0; }
.preview-pane th, .preview-pane td { border: 1px solid var(--border); padding: 6px 10px; text-align: left; }
.preview-pane th { background: var(--bg-lighter); }

/* ===== Module selector pills ===== */
.module-pills {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 16px;
}

.module-pill {
  padding: 4px 12px;
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 0.8rem;
  background: var(--bg-card);
  color: var(--text-dim);
  cursor: pointer;
  transition: var(--transition);
}
.module-pill:hover { border-color: var(--green-dim); color: var(--text-main); }
.module-pill.active { border-color: var(--green-bright); color: var(--green-bright); background: var(--green-glow); }

/* ===== Raw YAML toggle ===== */
.raw-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  font-size: 0.8rem;
  color: var(--text-dim);
}

.raw-error {
  color: var(--red);
  font-size: 0.8rem;
  margin-top: 4px;
  font-family: var(--font-mono);
}

textarea.raw-yaml {
  min-height: 400px;
  border-color: var(--border);
}
textarea.raw-yaml.error { border-color: var(--red); }

/* ===== Build output ===== */
.build-output {
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  font-family: var(--font-mono);
  font-size: 0.8rem;
  white-space: pre-wrap;
  word-break: break-all;
  max-height: 500px;
  overflow-y: auto;
  min-height: 100px;
  color: var(--text-dim);
  line-height: 1.6;
}

.build-output.success { border-color: var(--green-dim); }
.build-output.error { border-color: var(--red); }

/* ===== Tag input ===== */
.tag-container {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 6px;
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  min-height: 38px;
  align-items: center;
}

.tag {
  display: flex;
  align-items: center;
  gap: 4px;
  background: var(--bg-lighter);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 2px 8px;
  font-size: 0.8rem;
}

.tag .tag-remove {
  cursor: pointer;
  color: var(--text-dim);
  font-size: 0.9rem;
  line-height: 1;
}
.tag .tag-remove:hover { color: var(--red); }

.tag-input {
  border: none !important;
  background: none !important;
  padding: 4px !important;
  flex: 1;
  min-width: 100px;
  box-shadow: none !important;
}
.tag-input:focus { outline: none; border: none !important; box-shadow: none !important; }

/* ===== Annotation editor ===== */
.annotation-type-row {
  display: grid;
  grid-template-columns: 120px 60px 140px auto;
  gap: 8px;
  align-items: center;
  margin-bottom: 8px;
}

/* ===== Responsive ===== */
@media (max-width: 768px) {
  .split-pane { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }
  .tab-bar { padding: 8px 12px 0; }
  .tab-btn { padding: 6px 10px; font-size: 0.8rem; }
  .container { padding: 0 12px; }
}

/* ===== Empty state ===== */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-dim);
}
.empty-state p { margin-top: 8px; }

/* ===== Toolbar ===== */
.toolbar {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

/* ===== Sortable drag ===== */
.drag-handle {
  cursor: grab;
  color: var(--text-dim);
  user-select: none;
  font-size: 1rem;
}
.drag-handle:hover { color: var(--text-main); }

.card.dragging {
  opacity: 0.4;
}
.card.drag-over {
  border-color: var(--green-bright);
  box-shadow: 0 0 0 2px var(--green-glow);
}

/* ===== Key-value pairs ===== */
.kv-row {
  display: grid;
  grid-template-columns: 1fr 1fr auto;
  gap: 8px;
  margin-bottom: 6px;
  align-items: center;
}

/* Section divider */
.section-divider {
  font-size: 0.8rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin: 20px 0 12px;
  padding-bottom: 4px;
  border-bottom: 1px solid var(--border);
}

/* ===== Course selector ===== */
.course-selector {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 24px;
}
.course-selector select { max-width: 300px; }

/* ===== No-course message ===== */
.no-course-msg {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 40px;
  text-align: center;
  color: var(--text-dim);
}

/* ===== Spinner ===== */
.spinner {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid var(--border);
  border-top-color: var(--green-bright);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  vertical-align: middle;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- ===== Header ===== -->
<header class="app-header">
  <h1>// course builder</h1>
  <div class="header-actions">
    <span class="status" id="status-text"></span>
    <button class="btn-primary btn-small" id="save-btn" onclick="saveAll()" title="Ctrl+S">Save</button>
  </div>
</header>

<!-- ===== Tab bar ===== -->
<div class="tab-bar" id="tab-bar">
  <button class="tab-btn active" data-tab="setup">Setup</button>
  <button class="tab-btn" data-tab="modules">Tracks & Modules</button>
  <button class="tab-btn" data-tab="lessons">Lessons</button>
  <button class="tab-btn" data-tab="exercises">Exercises</button>
  <button class="tab-btn" data-tab="flashcards">Flashcards</button>
  <button class="tab-btn" data-tab="algorithms">Algorithms</button>
  <button class="tab-btn" data-tab="challenges">Challenges</button>
  <button class="tab-btn" data-tab="build">Build</button>
</div>

<!-- ===== Tab panels ===== -->
<div class="container">

<!-- SETUP TAB -->
<div class="tab-content active" id="tab-setup">
  <div class="course-selector">
    <select id="course-select" onchange="loadCourse(this.value)">
      <option value="">-- Select a course --</option>
    </select>
    <button class="btn-primary btn-small" onclick="showNewCourseDialog()">+ New Course</button>
  </div>

  <div id="setup-content">
    <div class="no-course-msg" id="no-course-msg">
      Select or create a course to get started.
    </div>
  </div>
</div>

<!-- MODULES TAB -->
<div class="tab-content" id="tab-modules">
  <div id="modules-content"></div>
</div>

<!-- LESSONS TAB -->
<div class="tab-content" id="tab-lessons">
  <div id="lessons-content"></div>
</div>

<!-- EXERCISES TAB -->
<div class="tab-content" id="tab-exercises">
  <div id="exercises-content"></div>
</div>

<!-- FLASHCARDS TAB -->
<div class="tab-content" id="tab-flashcards">
  <div id="flashcards-content"></div>
</div>

<!-- ALGORITHMS TAB -->
<div class="tab-content" id="tab-algorithms">
  <div id="algorithms-content"></div>
</div>

<!-- CHALLENGES TAB -->
<div class="tab-content" id="tab-challenges">
  <div id="challenges-content"></div>
</div>

<!-- BUILD TAB -->
<div class="tab-content" id="tab-build">
  <div id="build-content"></div>
</div>

</div><!-- /container -->

<!-- ===== New course dialog ===== -->
<div id="new-course-dialog" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200; display:none; align-items:center; justify-content:center;">
  <div class="card" style="max-width:400px; width:100%;">
    <h3 style="margin-bottom:16px;">Create New Course</h3>
    <div class="form-group">
      <label>Course Slug</label>
      <input type="text" id="new-course-slug" placeholder="e.g. python-ds" pattern="[a-z0-9]+(-[a-z0-9]+)*">
      <div class="form-hint">Lowercase letters, numbers, hyphens only.</div>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn-secondary" onclick="hideNewCourseDialog()">Cancel</button>
      <button class="btn-primary" onclick="createCourse()">Create</button>
    </div>
  </div>
</div>

<script src="/lib/marked.umd.js"></script>
<script src="/lib/js-yaml.min.js"></script>
<script>
// =========================================================================
// State
// =========================================================================
const state = {
  courses: [],
  slug: null,
  manifest: null,
  lessons: {},
  exercises: {},
  flashcards: null,
  algorithms: null,
  challenges: null,
  dirty: false,
  saving: false,
  // Per-tab selected module
  selectedLessonModule: null,
  selectedExerciseModule: null,
  selectedFlashcardModule: null,
};

// =========================================================================
// API helpers
// =========================================================================
const API = {
  async get(path) {
    const r = await fetch('/api/' + path);
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  },
  async post(path, body) {
    const r = await fetch('/api/' + path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!r.ok) {
      const data = await r.json().catch(() => ({ error: 'Request failed' }));
      throw new Error(data.error || 'Request failed');
    }
    return r.json();
  },
  async put(path, body) {
    const r = await fetch('/api/' + path, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  },
};

// =========================================================================
// Tab navigation
// =========================================================================
document.getElementById('tab-bar').addEventListener('click', e => {
  const btn = e.target.closest('.tab-btn');
  if (!btn) return;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
});

// =========================================================================
// Status bar
// =========================================================================
function setStatus(text, cls) {
  const el = document.getElementById('status-text');
  el.textContent = text;
  el.className = 'status' + (cls ? ' ' + cls : '');
}

function markDirty() {
  state.dirty = true;
  setStatus('Unsaved changes', 'dirty');
}

function markClean() {
  state.dirty = false;
  setStatus('Saved', '');
  setTimeout(() => { if (!state.dirty) setStatus('', ''); }, 2000);
}

// =========================================================================
// Course loading
// =========================================================================
async function loadCourseList() {
  state.courses = await API.get('courses');
  const sel = document.getElementById('course-select');
  const current = sel.value;
  sel.innerHTML = '<option value="">-- Select a course --</option>';
  state.courses.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.slug;
    opt.textContent = c.name + ' (' + c.slug + ')';
    sel.appendChild(opt);
  });
  if (current) sel.value = current;
}

async function loadCourse(slug) {
  if (!slug) {
    state.slug = null;
    state.manifest = null;
    document.getElementById('no-course-msg').style.display = '';
    renderAllTabs();
    return;
  }

  setStatus('Loading...', 'saving');
  try {
    const data = await API.get('courses/' + slug);
    state.slug = slug;
    state.manifest = data.manifest;
    state.lessons = data.lessons || {};
    state.exercises = data.exercises || {};
    state.flashcards = data.flashcards;
    state.algorithms = data.algorithms;
    state.challenges = data.challenges;
    state.dirty = false;
    state.selectedLessonModule = null;
    state.selectedExerciseModule = null;
    state.selectedFlashcardModule = null;
    setStatus('', '');
    renderAllTabs();
  } catch (e) {
    setStatus('Error: ' + e.message, 'error');
  }
}

// =========================================================================
// New course dialog
// =========================================================================
function showNewCourseDialog() {
  const d = document.getElementById('new-course-dialog');
  d.style.display = 'flex';
  document.getElementById('new-course-slug').value = '';
  document.getElementById('new-course-slug').focus();
}

function hideNewCourseDialog() {
  document.getElementById('new-course-dialog').style.display = 'none';
}

async function createCourse() {
  const slug = document.getElementById('new-course-slug').value.trim();
  if (!slug) return;
  try {
    await API.post('courses', { slug });
    hideNewCourseDialog();
    await loadCourseList();
    document.getElementById('course-select').value = slug;
    await loadCourse(slug);
  } catch (e) {
    alert(e.message);
  }
}

// Handle Enter in new course dialog
document.getElementById('new-course-slug').addEventListener('keydown', e => {
  if (e.key === 'Enter') createCourse();
  if (e.key === 'Escape') hideNewCourseDialog();
});

// =========================================================================
// Save all
// =========================================================================
async function saveAll() {
  if (!state.slug || !state.manifest) return;
  state.saving = true;
  setStatus('Saving...', 'saving');

  try {
    // Save course.yaml
    await API.put('courses/' + state.slug + '/course-yaml', { data: state.manifest });

    // Save lessons
    for (const [id, content] of Object.entries(state.lessons)) {
      if (String(id).startsWith('project-')) continue; // skip project lessons for now
      await API.put('courses/' + state.slug + '/lessons/' + id, { content });
    }

    // Save exercises
    for (const [id, data] of Object.entries(state.exercises)) {
      if (data) await API.put('courses/' + state.slug + '/exercises/' + id, { data });
    }

    // Save flashcards
    if (state.flashcards) {
      await API.put('courses/' + state.slug + '/flashcards', { data: state.flashcards });
    }

    // Save algorithms
    if (state.algorithms) {
      await API.put('courses/' + state.slug + '/algorithms', { data: state.algorithms });
    }

    // Save challenges
    if (state.challenges) {
      await API.put('courses/' + state.slug + '/challenges', { data: state.challenges });
    }

    state.saving = false;
    markClean();
  } catch (e) {
    state.saving = false;
    setStatus('Save failed: ' + e.message, 'error');
  }
}

// =========================================================================
// UI helpers
// =========================================================================
function el(tag, attrs, ...children) {
  const e = document.createElement(tag);
  if (attrs) {
    for (const [k, v] of Object.entries(attrs)) {
      if (k === 'className') e.className = v;
      else if (k === 'style' && typeof v === 'object') Object.assign(e.style, v);
      else if (k.startsWith('on')) e.addEventListener(k.slice(2).toLowerCase(), v);
      else e.setAttribute(k, v);
    }
  }
  for (const child of children) {
    if (child == null) continue;
    if (typeof child === 'string') e.appendChild(document.createTextNode(child));
    else e.appendChild(child);
  }
  return e;
}

function clearEl(container) {
  if (typeof container === 'string') container = document.getElementById(container);
  container.innerHTML = '';
  return container;
}

function createTextInput(label, value, onChange, opts = {}) {
  const g = el('div', { className: 'form-group' });
  if (label) g.appendChild(el('label', null, label));
  const inp = el('input', {
    type: opts.type || 'text',
    value: value || '',
    placeholder: opts.placeholder || '',
    onInput: e => { onChange(e.target.value); markDirty(); }
  });
  g.appendChild(inp);
  if (opts.hint) g.appendChild(el('div', { className: 'form-hint' }, opts.hint));
  return g;
}

function createTextarea(label, value, onChange, opts = {}) {
  const g = el('div', { className: 'form-group' });
  if (label) g.appendChild(el('label', null, label));
  const ta = el('textarea', {
    className: opts.code ? 'code-editor' : '',
    placeholder: opts.placeholder || '',
    rows: opts.rows || 6,
    onInput: e => { onChange(e.target.value); markDirty(); },
    onKeydown: e => {
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = e.target.selectionStart;
        const end = e.target.selectionEnd;
        e.target.value = e.target.value.substring(0, start) + '  ' + e.target.value.substring(end);
        e.target.selectionStart = e.target.selectionEnd = start + 2;
        onChange(e.target.value);
        markDirty();
      }
    }
  });
  ta.value = value || '';
  g.appendChild(ta);
  if (opts.hint) g.appendChild(el('div', { className: 'form-hint' }, opts.hint));
  return g;
}

function createCheckbox(label, checked, onChange) {
  const row = el('div', { className: 'checkbox-row' });
  const cb = el('input', {
    type: 'checkbox',
    onChange: e => { onChange(e.target.checked); markDirty(); }
  });
  cb.checked = checked;
  row.appendChild(cb);
  row.appendChild(el('label', null, label));
  return row;
}

function createDynamicList(label, items, onUpdate, renderItem) {
  const wrapper = el('div', { className: 'form-group' });
  if (label) wrapper.appendChild(el('label', null, label));

  const listEl = el('div');
  const render = () => {
    clearEl(listEl);
    items.forEach((item, i) => {
      const row = el('div', { className: 'dyn-list-item' });
      row.appendChild(renderItem(item, i, () => {
        markDirty();
        onUpdate(items);
        render();
      }));
      row.appendChild(el('button', {
        className: 'btn-icon',
        title: 'Remove',
        onClick: () => { items.splice(i, 1); markDirty(); onUpdate(items); render(); }
      }, '\u00d7'));
      if (i > 0) {
        row.appendChild(el('button', {
          className: 'btn-icon',
          title: 'Move up',
          onClick: () => { [items[i-1], items[i]] = [items[i], items[i-1]]; markDirty(); onUpdate(items); render(); }
        }, '\u2191'));
      }
      listEl.appendChild(row);
    });
  };
  render();

  wrapper.appendChild(listEl);
  wrapper.appendChild(el('button', {
    className: 'btn-secondary btn-small',
    onClick: () => { items.push(''); markDirty(); onUpdate(items); render(); }
  }, '+ Add'));
  return wrapper;
}

function createCollapsible(title, renderBody, startOpen) {
  const wrapper = el('div', { style: { marginBottom: '8px' } });
  const header = el('button', { className: 'collapsible-header' + (startOpen ? ' open' : '') },
    el('span', { className: 'collapsible-arrow' }, '\u25b6'),
    el('span', null, title)
  );
  const body = el('div', { className: 'collapsible-body' + (startOpen ? ' open' : '') });
  renderBody(body);
  header.addEventListener('click', () => {
    header.classList.toggle('open');
    body.classList.toggle('open');
  });
  wrapper.appendChild(header);
  wrapper.appendChild(body);
  return wrapper;
}

function createTagInput(label, tags, onChange) {
  const g = el('div', { className: 'form-group' });
  if (label) g.appendChild(el('label', null, label));

  const container = el('div', { className: 'tag-container' });

  const render = () => {
    // Remove all tags, keep input
    Array.from(container.querySelectorAll('.tag')).forEach(t => t.remove());
    const inp = container.querySelector('.tag-input');
    tags.forEach((tag, i) => {
      const tagEl = el('span', { className: 'tag' },
        el('span', null, tag),
        el('span', { className: 'tag-remove', onClick: () => { tags.splice(i, 1); markDirty(); onChange(tags); render(); } }, '\u00d7')
      );
      container.insertBefore(tagEl, inp);
    });
  };

  const inp = el('input', {
    className: 'tag-input',
    type: 'text',
    placeholder: 'Type and press Enter...',
    onKeydown: e => {
      if (e.key === 'Enter' && e.target.value.trim()) {
        e.preventDefault();
        tags.push(e.target.value.trim());
        e.target.value = '';
        markDirty();
        onChange(tags);
        render();
      }
      if (e.key === 'Backspace' && !e.target.value && tags.length) {
        tags.pop();
        markDirty();
        onChange(tags);
        render();
      }
    }
  });
  container.appendChild(inp);
  g.appendChild(container);
  render();
  return g;
}

function createRawYamlToggle(getData, setData, renderForm, container) {
  let rawMode = false;
  let rawTextarea = null;
  let errorEl = null;

  const toggle = el('div', { className: 'raw-toggle' });
  const cb = el('input', { type: 'checkbox', style: { width: '16px', height: '16px' },
    onChange: () => {
      rawMode = cb.checked;
      if (rawMode) {
        // Switch to raw
        const data = getData();
        const yamlStr = jsyaml.dump(data, { lineWidth: -1, noRefs: true, quotingType: '"' });
        formContainer.style.display = 'none';
        rawContainer.style.display = '';
        rawTextarea.value = yamlStr;
        if (errorEl) errorEl.textContent = '';
      } else {
        // Switch back to form
        try {
          const parsed = jsyaml.load(rawTextarea.value);
          setData(parsed);
          markDirty();
          formContainer.style.display = '';
          rawContainer.style.display = 'none';
          renderForm(formContainer);
          if (errorEl) errorEl.textContent = '';
        } catch (e) {
          cb.checked = true;
          rawMode = true;
          if (errorEl) errorEl.textContent = 'YAML parse error: ' + e.message;
          rawTextarea.classList.add('error');
        }
      }
    }
  });
  toggle.appendChild(cb);
  toggle.appendChild(el('span', null, 'Raw YAML'));

  const rawContainer = el('div', { style: { display: 'none' } });
  rawTextarea = el('textarea', {
    className: 'raw-yaml code-editor',
    rows: 20,
    onInput: () => {
      rawTextarea.classList.remove('error');
      if (errorEl) errorEl.textContent = '';
      markDirty();
    }
  });
  rawContainer.appendChild(rawTextarea);
  errorEl = el('div', { className: 'raw-error' });
  rawContainer.appendChild(errorEl);

  const formContainer = el('div');
  renderForm(formContainer);

  container.appendChild(toggle);
  container.appendChild(rawContainer);
  container.appendChild(formContainer);

  return { rawContainer, formContainer, rawTextarea, isRaw: () => rawMode, getRawValue: () => rawTextarea.value };
}

function getModules() {
  if (!state.manifest) return [];
  return (state.manifest.modules || []).map((m, i) => ({
    ...m,
    _id: m.id !== undefined ? m.id : i,
    _index: i
  }));
}

function renderModulePills(selectedId, onSelect) {
  const pills = el('div', { className: 'module-pills' });
  getModules().forEach(m => {
    const pill = el('button', {
      className: 'module-pill' + (selectedId === m._id ? ' active' : ''),
      onClick: () => onSelect(m._id)
    }, m.title || ('Module ' + m._id));
    pills.appendChild(pill);
  });
  return pills;
}

// =========================================================================
// Render: Setup tab
// =========================================================================
function renderSetup() {
  const container = document.getElementById('setup-content');
  clearEl(container);
  if (!state.manifest) {
    container.appendChild(el('div', { className: 'no-course-msg' }, 'Select or create a course to get started.'));
    return;
  }

  const c = state.manifest.course || {};

  const card = el('div', { className: 'card' });
  card.appendChild(el('div', { className: 'card-header' },
    el('h3', null, 'Course Metadata')
  ));

  createRawYamlToggle(
    () => state.manifest,
    (data) => { state.manifest = data; },
    (fc) => {
      clearEl(fc);
      fc.appendChild(createTextInput('Course Name', c.name, v => { c.name = v; }));

      const row = el('div', { className: 'form-row' });
      row.appendChild(createTextInput('Slug', c.slug, v => { c.slug = v; }, { hint: 'URL-safe identifier' }));
      row.appendChild(createTextInput('Storage Prefix', c.storagePrefix, v => { c.storagePrefix = v; }, { hint: 'Namespaces localStorage keys' }));
      fc.appendChild(row);

      fc.appendChild(createTextarea('Description', c.description, v => { c.description = v; }, { rows: 3 }));

      // Status
      fc.appendChild(createTextInput('Status', c.status || '', v => { if (v) c.status = v; else delete c.status; }, { placeholder: 'e.g. Template, Draft, Complete' }));

      // Hidden
      fc.appendChild(createCheckbox('Hidden (excluded from landing page)', c.hidden || false, v => { if (v) c.hidden = true; else delete c.hidden; }));

      // Annotation types
      fc.appendChild(el('div', { className: 'section-divider' }, 'Annotation Types'));
      const annTypes = state.manifest.annotationTypes || {};
      const annContainer = el('div');

      const renderAnnotations = () => {
        clearEl(annContainer);
        const keys = Object.keys(annTypes);
        keys.forEach(key => {
          const at = annTypes[key];
          const row = el('div', { className: 'annotation-type-row' });
          row.appendChild(el('input', {
            type: 'text', value: key, placeholder: 'key',
            onInput: e => {
              const newKey = e.target.value;
              if (newKey && newKey !== key) {
                annTypes[newKey] = annTypes[key];
                delete annTypes[key];
                state.manifest.annotationTypes = annTypes;
                markDirty();
                renderAnnotations();
              }
            }
          }));
          row.appendChild(el('input', {
            type: 'text', value: at.icon || '', placeholder: 'icon',
            style: { width: '50px' },
            onInput: e => { at.icon = e.target.value; markDirty(); }
          }));
          row.appendChild(el('input', {
            type: 'text', value: at.cssClass || '', placeholder: 'cssClass',
            onInput: e => { at.cssClass = e.target.value; markDirty(); }
          }));
          row.appendChild(el('button', {
            className: 'btn-icon', onClick: () => { delete annTypes[key]; state.manifest.annotationTypes = annTypes; markDirty(); renderAnnotations(); }
          }, '\u00d7'));
          annContainer.appendChild(row);
        });
      };
      renderAnnotations();
      fc.appendChild(annContainer);
      fc.appendChild(el('button', {
        className: 'btn-secondary btn-small',
        onClick: () => { annTypes['new-type'] = { icon: '?', cssClass: 'ann-new' }; state.manifest.annotationTypes = annTypes; markDirty(); renderAnnotations(); }
      }, '+ Add Annotation Type'));
    },
    card
  );

  container.appendChild(card);
}

// =========================================================================
// Render: Tracks & Modules tab
// =========================================================================
function renderModules() {
  const container = clearEl('modules-content');
  if (!state.manifest) {
    container.appendChild(el('div', { className: 'no-course-msg' }, 'Select a course first.'));
    return;
  }

  const modules = state.manifest.modules || [];
  const tracks = state.manifest.tracks || [];
  const projects = state.manifest.projects || [];

  // Modules section
  container.appendChild(el('div', { className: 'section-divider' }, 'Modules'));

  modules.forEach((mod, i) => {
    const id = mod.id !== undefined ? mod.id : i;
    const card = el('div', { className: 'card' });
    const header = el('div', { className: 'card-header' });
    header.appendChild(el('h3', null, 'Module ' + id + ': ' + (mod.title || 'Untitled')));
    const actions = el('div', { className: 'card-actions' });
    if (i > 0) actions.appendChild(el('button', { className: 'btn-icon', title: 'Move up',
      onClick: () => { [modules[i-1], modules[i]] = [modules[i], modules[i-1]]; markDirty(); renderModules(); }
    }, '\u2191'));
    if (i < modules.length - 1) actions.appendChild(el('button', { className: 'btn-icon', title: 'Move down',
      onClick: () => { [modules[i], modules[i+1]] = [modules[i+1], modules[i]]; markDirty(); renderModules(); }
    }, '\u2193'));
    actions.appendChild(el('button', { className: 'btn-icon', title: 'Remove module',
      onClick: () => {
        if (confirm('Remove module "' + mod.title + '"? (Files will NOT be deleted)')) {
          modules.splice(i, 1);
          markDirty();
          renderModules();
        }
      }
    }, '\u00d7'));
    header.appendChild(actions);
    card.appendChild(header);

    card.appendChild(createTextInput('Title', mod.title, v => { mod.title = v; }));
    card.appendChild(createTextInput('Description', mod.description || '', v => { mod.description = v; }));
    card.appendChild(createCheckbox('Has Exercises', mod.hasExercises !== false, v => {
      if (v) delete mod.hasExercises; else mod.hasExercises = false;
    }));

    container.appendChild(card);
  });

  container.appendChild(el('button', { className: 'btn-primary',
    onClick: () => {
      modules.push({ title: 'New Module', description: '' });
      markDirty();
      // Create placeholder lesson file
      const newId = modules.length - 1;
      state.lessons[newId] = state.lessons[newId] || '## Welcome\n\nNew module content here.\n';
      renderModules();
    }
  }, '+ Add Module'));

  // Tracks section
  container.appendChild(el('div', { className: 'section-divider', style: { marginTop: '32px' } }, 'Tracks'));

  tracks.forEach((track, i) => {
    const card = el('div', { className: 'card' });
    const header = el('div', { className: 'card-header' });
    header.appendChild(el('h3', null, track.title || 'Untitled Track'));
    const actions = el('div', { className: 'card-actions' });
    actions.appendChild(el('button', { className: 'btn-icon', title: 'Remove track',
      onClick: () => { tracks.splice(i, 1); markDirty(); renderModules(); }
    }, '\u00d7'));
    header.appendChild(actions);
    card.appendChild(header);

    card.appendChild(createTextInput('Title', track.title, v => { track.title = v; }));

    // Module IDs for this track
    const trackModules = track.modules || [];
    card.appendChild(createDynamicList(
      'Module IDs',
      trackModules.map(String),
      updated => { track.modules = updated.map(v => parseInt(v, 10) || 0); },
      (item, idx, refresh) => {
        const inp = el('input', {
          type: 'text', value: item,
          placeholder: 'Module ID',
          onInput: e => { trackModules[idx] = e.target.value; track.modules = trackModules.map(v => parseInt(v, 10) || 0); markDirty(); }
        });
        return inp;
      }
    ));

    container.appendChild(card);
  });

  container.appendChild(el('button', { className: 'btn-secondary',
    onClick: () => { tracks.push({ title: 'New Track', modules: [] }); markDirty(); renderModules(); }
  }, '+ Add Track'));

  // Projects section
  container.appendChild(el('div', { className: 'section-divider', style: { marginTop: '32px' } }, 'Projects'));

  projects.forEach((proj, i) => {
    const card = el('div', { className: 'card' });
    const header = el('div', { className: 'card-header' });
    header.appendChild(el('h3', null, (proj.num || 'P' + (i+1)) + ': ' + (proj.title || 'Untitled')));
    const actions = el('div', { className: 'card-actions' });
    actions.appendChild(el('button', { className: 'btn-icon', title: 'Remove project',
      onClick: () => { projects.splice(i, 1); markDirty(); renderModules(); }
    }, '\u00d7'));
    header.appendChild(actions);
    card.appendChild(header);

    const row = el('div', { className: 'form-row' });
    row.appendChild(createTextInput('ID', proj.id, v => { proj.id = v; }));
    row.appendChild(createTextInput('Num', proj.num, v => { proj.num = v; }));
    card.appendChild(row);

    card.appendChild(createTextInput('Title', proj.title, v => { proj.title = v; }));
    card.appendChild(createTextInput('File', proj.file, v => { proj.file = v; }, { hint: 'e.g. project-taskrunner (maps to content/lessons/project-taskrunner.md)' }));
    card.appendChild(createTextInput('After Module', String(proj.afterModule != null ? proj.afterModule : ''), v => { proj.afterModule = parseInt(v, 10); }, { type: 'number' }));
    card.appendChild(createTextInput('Description', proj.description || '', v => { proj.description = v; }));

    container.appendChild(card);
  });

  container.appendChild(el('button', { className: 'btn-secondary',
    onClick: () => {
      const num = 'P' + (projects.length + 1);
      projects.push({ id: 'p' + (projects.length + 1), num, title: 'New Project', file: 'project-new', afterModule: 0, description: '' });
      if (!state.manifest.projects) state.manifest.projects = projects;
      markDirty();
      renderModules();
    }
  }, '+ Add Project'));
}

// =========================================================================
// Render: Lessons tab
// =========================================================================
let previewDebounce = null;

function renderLessons() {
  const container = clearEl('lessons-content');
  if (!state.manifest) {
    container.appendChild(el('div', { className: 'no-course-msg' }, 'Select a course first.'));
    return;
  }

  const modules = getModules();
  if (!modules.length) {
    container.appendChild(el('div', { className: 'no-course-msg' }, 'Add modules first.'));
    return;
  }

  if (state.selectedLessonModule == null) state.selectedLessonModule = modules[0]._id;

  container.appendChild(renderModulePills(state.selectedLessonModule, id => {
    state.selectedLessonModule = id;
    renderLessons();
  }));

  const mid = state.selectedLessonModule;
  const content = state.lessons[mid] || '';

  const pane = el('div', { className: 'split-pane' });

  // Editor side
  const editorSide = el('div');
  editorSide.appendChild(el('div', { className: 'pane-header' }, 'Markdown'));
  const ta = el('textarea', {
    className: 'code-editor',
    rows: 25,
    onInput: e => {
      state.lessons[mid] = e.target.value;
      markDirty();
      clearTimeout(previewDebounce);
      previewDebounce = setTimeout(() => updatePreview(e.target.value, preview), 300);
    },
    onKeydown: e => {
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = e.target.selectionStart;
        const end = e.target.selectionEnd;
        e.target.value = e.target.value.substring(0, start) + '  ' + e.target.value.substring(end);
        e.target.selectionStart = e.target.selectionEnd = start + 2;
        state.lessons[mid] = e.target.value;
        markDirty();
      }
    }
  });
  ta.value = content;
  editorSide.appendChild(ta);
  pane.appendChild(editorSide);

  // Preview side
  const previewSide = el('div');
  previewSide.appendChild(el('div', { className: 'pane-header' }, 'Preview'));
  const preview = el('div', { className: 'preview-pane' });
  updatePreview(content, preview);
  previewSide.appendChild(preview);
  pane.appendChild(previewSide);

  container.appendChild(pane);
}

function updatePreview(md, previewEl) {
  try {
    previewEl.innerHTML = marked.parse(md || '');
  } catch {
    previewEl.innerHTML = '<em>Preview error</em>';
  }
}

// =========================================================================
// Render: Exercises tab
// =========================================================================
function renderExercises() {
  const container = clearEl('exercises-content');
  if (!state.manifest) {
    container.appendChild(el('div', { className: 'no-course-msg' }, 'Select a course first.'));
    return;
  }

  const modules = getModules().filter(m => m.hasExercises !== false);
  if (!modules.length) {
    container.appendChild(el('div', { className: 'no-course-msg' }, 'No modules with exercises enabled.'));
    return;
  }

  if (state.selectedExerciseModule == null) state.selectedExerciseModule = modules[0]._id;

  container.appendChild(renderModulePills(state.selectedExerciseModule, id => {
    state.selectedExerciseModule = id;
    renderExercises();
  }));

  const mid = state.selectedExerciseModule;
  let exData = state.exercises[mid];

  if (!exData) {
    exData = { conceptLinks: {}, sharedContent: {}, variants: { warmups: [], challenges: [] } };
    state.exercises[mid] = exData;
  }

  // Normalize structure - some files have warmups/challenges at top level
  if (!exData.variants && (exData.warmups || exData.challenges)) {
    exData.variants = { warmups: exData.warmups || [], challenges: exData.challenges || [] };
    delete exData.warmups;
    delete exData.challenges;
  }
  if (!exData.variants) exData.variants = { warmups: [], challenges: [] };

  const card = el('div', { className: 'card' });

  createRawYamlToggle(
    () => exData,
    (data) => { state.exercises[mid] = data; exData = data; },
    (fc) => {
      clearEl(fc);

      // Concept Links
      fc.appendChild(el('div', { className: 'section-divider' }, 'Concept Links'));
      const clContainer = el('div');
      const renderConceptLinks = () => {
        clearEl(clContainer);
        const links = exData.conceptLinks || {};
        Object.entries(links).forEach(([key, val]) => {
          const row = el('div', { className: 'kv-row' });
          row.appendChild(el('input', {
            type: 'text', value: key, placeholder: 'Concept name',
            onInput: e => {
              const newKey = e.target.value;
              if (newKey !== key) {
                links[newKey] = links[key];
                delete links[key];
                markDirty();
              }
            }
          }));
          row.appendChild(el('input', {
            type: 'text', value: val, placeholder: '#lesson-anchor',
            onInput: e => { links[Object.keys(links).find(k => links[k] === val && k !== key) || key] = e.target.value; markDirty(); }
          }));
          row.appendChild(el('button', { className: 'btn-icon', onClick: () => { delete links[key]; markDirty(); renderConceptLinks(); } }, '\u00d7'));
          clContainer.appendChild(row);
        });
      };
      renderConceptLinks();
      fc.appendChild(clContainer);
      fc.appendChild(el('button', { className: 'btn-secondary btn-small',
        onClick: () => { if (!exData.conceptLinks) exData.conceptLinks = {}; exData.conceptLinks['New Concept'] = '#lesson-section'; markDirty(); renderConceptLinks(); }
      }, '+ Add Concept Link'));

      // Warmups
      fc.appendChild(el('div', { className: 'section-divider', style: { marginTop: '24px' } }, 'Warmups'));
      renderExerciseGroup(fc, exData.variants.warmups || [], 'warmup');

      fc.appendChild(el('button', { className: 'btn-secondary btn-small',
        onClick: () => {
          if (!exData.variants.warmups) exData.variants.warmups = [];
          const newId = 'warmup_' + (exData.variants.warmups.length + 1);
          exData.variants.warmups.push({ id: newId, concept: '', variants: [{ id: 'v1', title: '', description: '', hints: [], solution: '' }] });
          markDirty();
          renderExercises();
        }
      }, '+ Add Warmup'));

      // Challenges
      fc.appendChild(el('div', { className: 'section-divider', style: { marginTop: '24px' } }, 'Challenges'));
      renderExerciseGroup(fc, exData.variants.challenges || [], 'challenge');

      fc.appendChild(el('button', { className: 'btn-secondary btn-small',
        onClick: () => {
          if (!exData.variants.challenges) exData.variants.challenges = [];
          const newId = 'challenge_' + (exData.variants.challenges.length + 1);
          exData.variants.challenges.push({ id: newId, concept: '', variants: [{ id: 'v1', title: '', description: '', hints: [], solution: '' }] });
          markDirty();
          renderExercises();
        }
      }, '+ Add Challenge'));
    },
    card
  );

  container.appendChild(card);
}

function renderExerciseGroup(parent, exercises, prefix) {
  exercises.forEach((ex, ei) => {
    parent.appendChild(createCollapsible(
      (ex.id || prefix + '_' + (ei + 1)) + ' \u2014 ' + (ex.concept || 'No concept'),
      body => {
        body.appendChild(createTextInput('ID', ex.id, v => { ex.id = v; }));
        body.appendChild(createTextInput('Concept', ex.concept, v => { ex.concept = v; }));

        // Variants
        const variants = ex.variants || [];
        variants.forEach((variant, vi) => {
          body.appendChild(createCollapsible(
            'Variant: ' + (variant.title || variant.id || 'v' + (vi + 1)),
            vBody => {
              const row = el('div', { className: 'form-row' });
              row.appendChild(createTextInput('Variant ID', variant.id, v => { variant.id = v; }));
              row.appendChild(createTextInput('Title', variant.title, v => { variant.title = v; }));
              vBody.appendChild(row);

              vBody.appendChild(createTextarea('Description', variant.description, v => { variant.description = v; }, { rows: 3 }));

              // Hints
              const hints = variant.hints || [];
              vBody.appendChild(createDynamicList('Hints', hints, updated => { variant.hints = updated; },
                (item, idx) => {
                  const inp = el('input', {
                    type: 'text', value: item,
                    onInput: e => { hints[idx] = e.target.value; variant.hints = hints; markDirty(); }
                  });
                  return inp;
                }
              ));

              vBody.appendChild(createTextarea('Solution', variant.solution, v => { variant.solution = v; }, { code: true, rows: 8 }));

              // Annotations
              const anns = variant.annotations || [];
              vBody.appendChild(el('div', { className: 'section-divider' }, 'Annotations'));
              anns.forEach((ann, ai) => {
                const annCard = el('div', { className: 'card', style: { padding: '8px', marginBottom: '6px' } });
                const annRow = el('div', { className: 'form-row' });
                annRow.appendChild(createTextInput('Type', ann.type, v => { ann.type = v; }));
                annRow.appendChild(createTextInput('Label', ann.label, v => { ann.label = v; }));
                annCard.appendChild(annRow);
                annCard.appendChild(createTextarea('Text', ann.text, v => { ann.text = v; }, { rows: 2 }));
                annCard.appendChild(el('button', { className: 'btn-icon', onClick: () => { anns.splice(ai, 1); markDirty(); renderExercises(); } }, '\u00d7 Remove annotation'));
                vBody.appendChild(annCard);
              });
              vBody.appendChild(el('button', { className: 'btn-secondary btn-small',
                onClick: () => {
                  if (!variant.annotations) variant.annotations = [];
                  variant.annotations.push({ type: 'tip', label: '', text: '' });
                  markDirty();
                  renderExercises();
                }
              }, '+ Add Annotation'));

              // Remove variant
              vBody.appendChild(el('div', { style: { marginTop: '12px' } },
                el('button', { className: 'btn-danger btn-small',
                  onClick: () => { variants.splice(vi, 1); markDirty(); renderExercises(); }
                }, 'Remove Variant')
              ));
            },
            vi === 0
          ));
        });

        body.appendChild(el('button', { className: 'btn-secondary btn-small',
          onClick: () => {
            const newId = 'v' + (variants.length + 1);
            variants.push({ id: newId, title: '', description: '', hints: [], solution: '' });
            markDirty();
            renderExercises();
          }
        }, '+ Add Variant'));

        // Remove exercise
        body.appendChild(el('div', { style: { marginTop: '12px' } },
          el('button', { className: 'btn-danger btn-small',
            onClick: () => {
              const list = exercises;
              list.splice(ei, 1);
              markDirty();
              renderExercises();
            }
          }, 'Remove Exercise')
        ));
      },
      false
    ));
  });
}

// =========================================================================
// Render: Flashcards tab
// =========================================================================
function renderFlashcards() {
  const container = clearEl('flashcards-content');
  if (!state.manifest) {
    container.appendChild(el('div', { className: 'no-course-msg' }, 'Select a course first.'));
    return;
  }

  const modules = getModules();
  if (!modules.length) {
    container.appendChild(el('div', { className: 'no-course-msg' }, 'Add modules first.'));
    return;
  }

  if (!state.flashcards) state.flashcards = {};

  if (state.selectedFlashcardModule == null) state.selectedFlashcardModule = modules[0]._id;

  container.appendChild(renderModulePills(state.selectedFlashcardModule, id => {
    state.selectedFlashcardModule = id;
    renderFlashcards();
  }));

  const mid = String(state.selectedFlashcardModule);
  const cards = state.flashcards[mid] || [];

  const card = el('div', { className: 'card' });

  createRawYamlToggle(
    () => state.flashcards,
    (data) => { state.flashcards = data; },
    (fc) => {
      clearEl(fc);

      cards.forEach((c, i) => {
        fc.appendChild(createCollapsible(
          (c.topic || 'Card ' + (i + 1)) + ' \u2014 ' + (c.q || '').substring(0, 50),
          body => {
            body.appendChild(createTextInput('Topic', c.topic, v => { c.topic = v; }));
            body.appendChild(createTextarea('Question', c.q, v => { c.q = v; }, { rows: 2 }));
            body.appendChild(createTextarea('Answer', c.a, v => { c.a = v; }, { rows: 4 }));
            body.appendChild(el('div', { style: { marginTop: '8px', display: 'flex', gap: '4px' } },
              i > 0 ? el('button', { className: 'btn-icon', title: 'Move up', onClick: () => { [cards[i-1], cards[i]] = [cards[i], cards[i-1]]; markDirty(); renderFlashcards(); } }, '\u2191') : null,
              i < cards.length - 1 ? el('button', { className: 'btn-icon', title: 'Move down', onClick: () => { [cards[i], cards[i+1]] = [cards[i+1], cards[i]]; markDirty(); renderFlashcards(); } }, '\u2193') : null,
              el('button', { className: 'btn-danger btn-small', onClick: () => { cards.splice(i, 1); state.flashcards[mid] = cards; markDirty(); renderFlashcards(); } }, 'Remove')
            ));
          },
          false
        ));
      });

      fc.appendChild(el('button', { className: 'btn-primary btn-small',
        onClick: () => {
          if (!state.flashcards[mid]) state.flashcards[mid] = [];
          state.flashcards[mid].push({ topic: '', q: '', a: '' });
          markDirty();
          renderFlashcards();
        }
      }, '+ Add Flashcard'));
    },
    card
  );

  container.appendChild(card);
}

// =========================================================================
// Render: Algorithms tab
// =========================================================================
function renderAlgorithms() {
  const container = clearEl('algorithms-content');
  if (!state.manifest) {
    container.appendChild(el('div', { className: 'no-course-msg' }, 'Select a course first.'));
    return;
  }

  if (!state.algorithms) {
    container.appendChild(el('div', { className: 'no-course-msg' },
      el('p', null, 'No algorithms.yaml found for this course.'),
      el('button', { className: 'btn-primary', style: { marginTop: '12px' },
        onClick: () => { state.algorithms = { categories: [] }; markDirty(); renderAlgorithms(); }
      }, 'Create algorithms.yaml')
    ));
    return;
  }

  const card = el('div', { className: 'card' });

  createRawYamlToggle(
    () => state.algorithms,
    (data) => { state.algorithms = data; },
    (fc) => {
      clearEl(fc);
      const categories = state.algorithms.categories || [];

      categories.forEach((cat, ci) => {
        fc.appendChild(createCollapsible(
          (cat.name || cat.id || 'Category ' + (ci + 1)),
          body => {
            const row = el('div', { className: 'form-row' });
            row.appendChild(createTextInput('ID', cat.id, v => { cat.id = v; }));
            row.appendChild(createTextInput('Name', cat.name, v => { cat.name = v; }));
            body.appendChild(row);

            const row2 = el('div', { className: 'form-row' });
            row2.appendChild(createTextInput('Icon', cat.icon, v => { cat.icon = v; }));
            row2.appendChild(createTextInput('Order', String(cat.order || ''), v => { cat.order = parseInt(v, 10) || 0; }));
            body.appendChild(row2);

            body.appendChild(createTextInput('Description', cat.description, v => { cat.description = v; }));

            // Problems
            const problems = cat.problems || [];
            body.appendChild(el('div', { className: 'section-divider' }, 'Problems'));

            problems.forEach((prob, pi) => {
              body.appendChild(createCollapsible(
                (prob.name || prob.id || 'Problem ' + (pi + 1)),
                pBody => {
                  const r1 = el('div', { className: 'form-row' });
                  r1.appendChild(createTextInput('ID', prob.id, v => { prob.id = v; }));
                  r1.appendChild(createTextInput('Name', prob.name, v => { prob.name = v; }));
                  pBody.appendChild(r1);

                  const r2 = el('div', { className: 'form-row' });
                  r2.appendChild(createTextInput('Concept', prob.concept, v => { prob.concept = v; }));
                  r2.appendChild(createTextInput('Difficulty', String(prob.difficulty || ''), v => { prob.difficulty = parseInt(v, 10) || 1; }, { type: 'number' }));
                  pBody.appendChild(r2);

                  // Variants
                  const variants = prob.variants || [];
                  pBody.appendChild(el('div', { className: 'section-divider' }, 'Variants'));

                  variants.forEach((variant, vi) => {
                    pBody.appendChild(createCollapsible(
                      variant.title || variant.id || 'v' + (vi + 1),
                      vBody => {
                        const vr = el('div', { className: 'form-row' });
                        vr.appendChild(createTextInput('ID', variant.id, v => { variant.id = v; }));
                        vr.appendChild(createTextInput('Title', variant.title, v => { variant.title = v; }));
                        vBody.appendChild(vr);
                        vBody.appendChild(createTextInput('Difficulty', String(variant.difficulty || ''), v => { variant.difficulty = parseInt(v, 10) || 1; }, { type: 'number' }));
                        vBody.appendChild(createTextarea('Description', variant.description, v => { variant.description = v; }, { rows: 3 }));

                        // Hints
                        const hints = variant.hints || [];
                        vBody.appendChild(createDynamicList('Hints', hints, updated => { variant.hints = updated; },
                          (item, idx) => el('input', {
                            type: 'text', value: item,
                            onInput: e => { hints[idx] = e.target.value; variant.hints = hints; markDirty(); }
                          })
                        ));

                        vBody.appendChild(createTextarea('Solution', variant.solution, v => { variant.solution = v; }, { code: true, rows: 10 }));
                        vBody.appendChild(createTextarea('Test Cases', variant.testCases, v => { variant.testCases = v; }, { code: true, rows: 4 }));

                        vBody.appendChild(el('button', { className: 'btn-danger btn-small', style: { marginTop: '8px' },
                          onClick: () => { variants.splice(vi, 1); markDirty(); renderAlgorithms(); }
                        }, 'Remove Variant'));
                      },
                      false
                    ));
                  });

                  pBody.appendChild(el('button', { className: 'btn-secondary btn-small',
                    onClick: () => {
                      if (!prob.variants) prob.variants = [];
                      prob.variants.push({ id: 'v' + (variants.length + 1), title: '', description: '', hints: [], solution: '', testCases: '' });
                      markDirty();
                      renderAlgorithms();
                    }
                  }, '+ Add Variant'));

                  pBody.appendChild(el('button', { className: 'btn-danger btn-small', style: { marginTop: '8px' },
                    onClick: () => { problems.splice(pi, 1); markDirty(); renderAlgorithms(); }
                  }, 'Remove Problem'));
                },
                false
              ));
            });

            body.appendChild(el('button', { className: 'btn-secondary btn-small',
              onClick: () => {
                if (!cat.problems) cat.problems = [];
                cat.problems.push({ id: 'new-problem', name: 'New Problem', concept: '', difficulty: 1, variants: [] });
                markDirty();
                renderAlgorithms();
              }
            }, '+ Add Problem'));

            body.appendChild(el('button', { className: 'btn-danger btn-small', style: { marginTop: '12px' },
              onClick: () => { categories.splice(ci, 1); markDirty(); renderAlgorithms(); }
            }, 'Remove Category'));
          },
          false
        ));
      });

      fc.appendChild(el('button', { className: 'btn-primary',
        onClick: () => {
          categories.push({ id: 'new-category', name: 'New Category', icon: '#', order: categories.length + 1, description: '', problems: [] });
          markDirty();
          renderAlgorithms();
        }
      }, '+ Add Category'));
    },
    card
  );

  container.appendChild(card);
}

// =========================================================================
// Render: Challenges tab
// =========================================================================
function renderChallenges() {
  const container = clearEl('challenges-content');
  if (!state.manifest) {
    container.appendChild(el('div', { className: 'no-course-msg' }, 'Select a course first.'));
    return;
  }

  if (!state.challenges) {
    container.appendChild(el('div', { className: 'no-course-msg' },
      el('p', null, 'No real-world-challenges.yaml found for this course.'),
      el('button', { className: 'btn-primary', style: { marginTop: '12px' },
        onClick: () => { state.challenges = { challenges: [] }; markDirty(); renderChallenges(); }
      }, 'Create real-world-challenges.yaml')
    ));
    return;
  }

  const card = el('div', { className: 'card' });

  createRawYamlToggle(
    () => state.challenges,
    (data) => { state.challenges = data; },
    (fc) => {
      clearEl(fc);
      const challenges = state.challenges.challenges || [];

      challenges.forEach((ch, ci) => {
        fc.appendChild(createCollapsible(
          (ch.title || ch.id || 'Challenge ' + (ci + 1)),
          body => {
            const row = el('div', { className: 'form-row' });
            row.appendChild(createTextInput('ID', ch.id, v => { ch.id = v; }));
            row.appendChild(createTextInput('Title', ch.title, v => { ch.title = v; }));
            body.appendChild(row);

            const row2 = el('div', { className: 'form-row' });
            row2.appendChild(createTextInput('Difficulty', String(ch.difficulty || ''), v => { ch.difficulty = parseInt(v, 10) || 1; }, { type: 'number' }));
            row2.appendChild(createTextInput('Source', ch.source || '', v => { ch.source = v; }));
            body.appendChild(row2);

            body.appendChild(createTextInput('Source URL', ch.sourceUrl || '', v => { ch.sourceUrl = v; }));
            body.appendChild(createTagInput('Companies', ch.companies || [], v => { ch.companies = v; }));
            body.appendChild(createTagInput('Concepts', ch.concepts || [], v => { ch.concepts = v; }));

            // Requirements (markdown with preview)
            body.appendChild(el('div', { className: 'section-divider' }, 'Requirements'));
            const reqSplit = el('div', { className: 'split-pane', style: { minHeight: '200px' } });
            const reqEditor = el('div');
            reqEditor.appendChild(el('div', { className: 'pane-header' }, 'Markdown'));
            const reqTa = el('textarea', {
              rows: 8,
              onInput: e => {
                ch.requirements = e.target.value;
                markDirty();
                clearTimeout(previewDebounce);
                previewDebounce = setTimeout(() => updatePreview(e.target.value, reqPreview), 300);
              }
            });
            reqTa.value = ch.requirements || '';
            reqEditor.appendChild(reqTa);
            reqSplit.appendChild(reqEditor);

            const reqPreviewSide = el('div');
            reqPreviewSide.appendChild(el('div', { className: 'pane-header' }, 'Preview'));
            const reqPreview = el('div', { className: 'preview-pane', style: { maxHeight: '300px' } });
            updatePreview(ch.requirements || '', reqPreview);
            reqPreviewSide.appendChild(reqPreview);
            reqSplit.appendChild(reqPreviewSide);
            body.appendChild(reqSplit);

            // Acceptance Criteria
            const criteria = ch.acceptanceCriteria || [];
            body.appendChild(createDynamicList('Acceptance Criteria', criteria, updated => { ch.acceptanceCriteria = updated; },
              (item, idx) => el('input', {
                type: 'text', value: item,
                onInput: e => { criteria[idx] = e.target.value; ch.acceptanceCriteria = criteria; markDirty(); }
              })
            ));

            // Hints
            body.appendChild(el('div', { className: 'section-divider' }, 'Hints'));
            const hints = ch.hints || [];
            hints.forEach((hint, hi) => {
              body.appendChild(createCollapsible(
                hint.title || 'Hint ' + (hi + 1),
                hBody => {
                  hBody.appendChild(createTextInput('Title', hint.title, v => { hint.title = v; }));
                  hBody.appendChild(createTextarea('Content', hint.content, v => { hint.content = v; }, { rows: 4 }));
                  hBody.appendChild(el('button', { className: 'btn-danger btn-small', onClick: () => { hints.splice(hi, 1); markDirty(); renderChallenges(); } }, 'Remove Hint'));
                },
                false
              ));
            });
            body.appendChild(el('button', { className: 'btn-secondary btn-small',
              onClick: () => {
                if (!ch.hints) ch.hints = [];
                ch.hints.push({ title: '', content: '' });
                markDirty();
                renderChallenges();
              }
            }, '+ Add Hint'));

            // Extensions
            const extensions = ch.extensions || [];
            body.appendChild(createDynamicList('Extensions', extensions, updated => { ch.extensions = updated; },
              (item, idx) => el('input', {
                type: 'text', value: item,
                onInput: e => { extensions[idx] = e.target.value; ch.extensions = extensions; markDirty(); }
              })
            ));

            body.appendChild(el('button', { className: 'btn-danger btn-small', style: { marginTop: '12px' },
              onClick: () => { challenges.splice(ci, 1); markDirty(); renderChallenges(); }
            }, 'Remove Challenge'));
          },
          false
        ));
      });

      fc.appendChild(el('button', { className: 'btn-primary',
        onClick: () => {
          challenges.push({
            id: 'new-challenge',
            title: 'New Challenge',
            difficulty: 2,
            companies: [],
            concepts: [],
            source: '',
            requirements: '',
            acceptanceCriteria: [],
            hints: [],
            extensions: []
          });
          markDirty();
          renderChallenges();
        }
      }, '+ Add Challenge'));
    },
    card
  );

  container.appendChild(card);
}

// =========================================================================
// Render: Build tab
// =========================================================================
function renderBuild() {
  const container = clearEl('build-content');
  if (!state.manifest) {
    container.appendChild(el('div', { className: 'no-course-msg' }, 'Select a course first.'));
    return;
  }

  const toolbar = el('div', { className: 'toolbar' });
  const buildBtn = el('button', { className: 'btn-primary',
    onClick: () => runBuild(state.slug)
  }, 'Build This Course');

  const buildAllBtn = el('button', { className: 'btn-secondary',
    onClick: () => runBuild(null)
  }, 'Build All Courses');

  toolbar.appendChild(buildBtn);
  toolbar.appendChild(buildAllBtn);
  container.appendChild(toolbar);

  container.appendChild(el('div', { className: 'form-hint', style: { marginBottom: '16px' } },
    'Build compiles YAML + Markdown into static HTML in dist/. Keyboard shortcut: Ctrl+B'));

  const output = el('div', { className: 'build-output', id: 'build-output' }, 'Build output will appear here...');
  container.appendChild(output);

  const courseSlug = (state.manifest.course || {}).slug || state.slug;
  const hint = el('div', { className: 'form-hint', style: { marginTop: '12px' } });
  hint.innerHTML = 'After building: <code style="background:var(--bg-code);padding:2px 6px;border-radius:3px;">cd dist && python3 -m http.server 8000</code> then open <a href="http://localhost:8000/' + courseSlug + '/" target="_blank" style="color:var(--green-dim);">http://localhost:8000/' + courseSlug + '/</a>';
  container.appendChild(hint);
}

async function runBuild(slug) {
  const output = document.getElementById('build-output');
  if (!output) return;
  output.textContent = 'Building...\n';
  output.className = 'build-output';

  try {
    const endpoint = slug ? 'build/' + slug : 'build';
    const result = await API.post(endpoint, {});
    output.textContent = result.output || 'Build completed.';
    output.classList.add(result.ok ? 'success' : 'error');
  } catch (e) {
    output.textContent = 'Build failed: ' + e.message;
    output.classList.add('error');
  }
}

// =========================================================================
// Render all tabs
// =========================================================================
function renderAllTabs() {
  renderSetup();
  renderModules();
  renderLessons();
  renderExercises();
  renderFlashcards();
  renderAlgorithms();
  renderChallenges();
  renderBuild();
}

// =========================================================================
// Keyboard shortcuts
// =========================================================================
document.addEventListener('keydown', e => {
  // Ctrl+S  Save
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveAll();
  }
  // Ctrl+B  Build
  if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
    e.preventDefault();
    if (state.slug) runBuild(state.slug);
  }
});

// Warn on unsaved changes
window.addEventListener('beforeunload', e => {
  if (state.dirty) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// =========================================================================
// Init
// =========================================================================
(async () => {
  await loadCourseList();
  renderAllTabs();
})();
</script>
</body>
</html>
